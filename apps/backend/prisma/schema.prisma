datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String     @id @default(cuid())
  discordId       String     @unique
  discordUsername String
  communityName   String?
  identifier      String?    @unique
  status          UserStatus @default(INACTIVE)
  loaUntil        DateTime?

  memberships UserDepartmentMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserStatus {
  INACTIVE
  ACTIVE
  LOA
  BANNED
}

model Department {
  id   String @id @default(cuid())
  name String @unique
  code String @db.VarChar(8)

  ranks       DepartmentRank[]
  memberships UserDepartmentMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DepartmentRank {
  id           String     @id @default(cuid())
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String

  name      String
  shortCode String?  @db.VarChar(8)
  level     Int // higher = more senior
  band      RankBand @default(BASE)

  memberships UserDepartmentMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId, level])
}

enum RankBand {
  BASE
  SUPERVISOR
  LEADERSHIP
  OWNER
}

model UserDepartmentMembership {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String

  department   Department @relation(fields: [departmentId], references: [id])
  departmentId String

  rank   DepartmentRank @relation(fields: [rankId], references: [id])
  rankId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, departmentId])
}
